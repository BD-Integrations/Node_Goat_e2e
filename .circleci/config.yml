version: 2.1
orbs:
  snyk: snyk/snyk@1.1.2

jobs:
  extract-docker-base-image:
    docker:
      - image: cimg/node:12.22  # Use the same base image as the main job
    steps:
      - checkout
      - run:
          name: Extract Dockerfile base image version
          command: |
            base_image_version=$(awk '/^FROM node:/ {print $2}' Dockerfile | cut -d ':' -f2)
            if [ -n "$base_image_version" ]; then
              echo "Using base image version: cimg/node:$base_image_version"
              echo "DOCKER_BASE_IMAGE=cimg/node:$base_image_version" >> $BASH_ENV
            else
              echo "Base image version not found in Dockerfile. Using default."
              echo "DOCKER_BASE_IMAGE=cimg/node:12.22" >> $BASH_ENV
            fi

  build-docker-image-and-snyk-scan:
    docker:
      - image: << pipeline.extract-docker-base-image.outputs.DOCKER_BASE_IMAGE >>
    environment:
      DOCKER_IMAGE: nodegoat
    steps:
      - checkout
      - run:
          name: Install Snyk CLI
          command: npm install -g snyk
      - run:
          name: Install Snyk to HTML
          command: npm install --prefix=$HOME/.local -g snyk-to-html
      - setup_remote_docker:
          version: 20.10.7
      - run:
          name: Build Docker Image
          command: |
            docker build -t $DOCKER_IMAGE:latest .
            snyk container test $DOCKER_IMAGE:latest --json | snyk-to-html -o results-container.html
      - store_artifacts:
          path: results-container.html

workflows:
  build-test-snyk:
    jobs:
      - extract-docker-base-image
      - build-docker-image-and-snyk-scan:
          requires:
            - extract-docker-base-image
